
Documentation
** Mise √† jours:** 04-01-2026

# üìò Feedverse ‚Äî Documentation Fonctionnelle
## üéØ Objectif

üß© **Feedverse est un moteur de narration.**  
Une application pour √©crire des histoires, des fanfictions ou des campagnes de jeu de r√¥le **comme si elles se d√©roulaient en temps r√©el**, √† travers plusieurs personnages.

---

## ‚ú® Description

Feedverse est une application de **cr√©ation narrative** con√ßue pour les roleplayers, les auteurs et les cr√©ateurs d‚Äôunivers.

Elle permet de raconter des histoires en incarnant **plusieurs personnages**, chacun avec sa propre identit√©, sa voix et sa place dans le r√©cit.  
Les interactions entre personnages deviennent le c≈ìur de la narration.

Au lieu de multiplier les outils ‚Äî notes, documents, discussions s√©par√©es ou montages d‚Äôimages ‚Äî Feedverse centralise tout dans un **espace pens√© pour √©crire et jouer**.

Vous cr√©ez un **sc√©nario** (un univers), puis autant de **profils de personnages** que n√©cessaire.  
Chaque profil peut publier, r√©pondre, citer, et faire avancer l‚Äôhistoire, seul ou √† plusieurs.

Feedverse est id√©al pour :
- √©crire des fanfictions ou des AU,
- faire interagir plusieurs OCs dans un m√™me univers,
- jouer des campagnes de jeu de r√¥le textuelles (comme du JDR ou du D&D asynchrone),
- construire des r√©cits qui √©voluent sur la dur√©e, jour apr√®s jour.

L‚Äôapplication ne cherche pas √† reproduire un r√©seau existant.  
Feedverse est un **outil cr√©atif**, pens√© comme un moteur de narration et un espace de jeu narratif.

---

## üß† Comment √ßa fonctionne

- üóÇÔ∏è **Sc√©narios s√©par√©s**  
  Chaque histoire poss√®de son propre univers, ind√©pendant des autres.

- üé≠ **Plusieurs profils par utilisateur**  
  Incarnez autant de personnages que n√©cessaire, sans contraintes techniques.

- ‚úçÔ∏è **Publications et interactions narratives**  
  Posts, r√©ponses et citations servent √† √©crire des dialogues, des sc√®nes et des √©v√©nements.

- üß© **Gestion fluide de nombreux personnages**  
  Plus besoin de cr√©er des faux screenshots ou des montages : tout est int√©gr√©.

- üë• **Solo ou collaboratif**  
  √âcrivez seul ou √† plusieurs, selon vos projets narratifs.

---

# üé® √Ä qui s‚Äôadresse Feedverse ?

- üé≠ Roleplayers (RP texte, univers partag√©s)
- üìù Auteurs et cr√©ateurs d‚ÄôOCs
- üé≤ Joueurs de JDR ou de D&D en version textuelle et asynchrone
- üë• Groupes souhaitant √©crire une histoire ensemble

---

# üå± En r√©sum√©

‚ú® Cr√©ez des univers  
üé≠ Incarnez plusieurs personnages  
üìñ √âcrivez des r√©cits vivants  
üé≤ Jouez des histoires √† plusieurs  
üß© Tout dans un seul moteur de narration

---

**Feedverse ‚Äî raconter des histoires autrement.**

# üìò Feedverse ‚Äî Syst√®me de Campagne

## üé≠ Concepts fondamentaux

### üóÇÔ∏è Sc√©nario

Un **sc√©nario** est un univers narratif ind√©pendant.

Un sc√©nario peut repr√©senter :
- une histoire,
- une fanfiction,
- une campagne JDR,
- une session RP longue.

Chaque sc√©nario poss√®de :
- ses propres profils,
- ses propres posts,
- ses r√®gles internes,
- son mode de fonctionnement.

---

### ‚öôÔ∏è Mode de sc√©nario

Lors de la cr√©ation d‚Äôun sc√©nario, un **mode** est s√©lectionn√© :

#### ‚úçÔ∏è Mode Narratif
- narration libre,
- posts classiques,
- RP collaboratif sans r√®gles m√©caniques.

#### üé≤ Mode Campagne (JDR)
Active des fonctionnalit√©s suppl√©mentaires :
- feuilles de personnage compl√®tes,
- syst√®me de jets de d√©s,
- r√¥les (MJ),
- posts √©pingl√©s
- journaux de campagne,
- combat / qu√™tes / logs.

---

## üé≠ Profils (Personnages)

Un **profil** repr√©sente un personnage incarn√© dans le sc√©nario.

### Types de profils

#### üë§ Profil Joueur
- appartient √† un utilisateur,
- repr√©sente un personnage jouable,
- poss√®de une feuille de personnage compl√®te,
- peut poster, r√©pondre, agir.

#### ü§ñ Profil Partag√© (NPC / Syst√®me)
- est cr√©e par un utilisateur
- est utilisable par les autres joueurs et le MJ
- sert pour :
  - PNJ,
  - narrateur,
  - syst√®me,
  - annonces,
  - posts √©pingl√©s

---

### üîê Partage de profils

Un profil peut √™tre :
- **priv√©** ‚Üí utilisable uniquement par son owner,
- **partag√©** ‚Üí utilisable par les autres joueurs.

---

## üé© R√¥le de Ma√Ætre du Jeu (MJ)

### Attribution du r√¥le MJ
- le cr√©ateur est MJ par d√©faut,
- le MJ peut attribuer le r√¥le √† d‚Äôautres joueurs.

### Capacit√©s du MJ
- cr√©er des posts √©pingl√©s,
- voir toutes les fiches,
- g√©rer jets, combats, qu√™tes.

---

## üßæ Feuille de personnage

### Identit√©
- nom, race, classe, niveau
- alignement, background

### üìä Statistiques
strength, dexterity, constitution, intelligence, wisdom, charisma

### ‚ù§Ô∏è Combat
- PV, PV max, √©tat

### üéí Inventaire
- objets, √©quipements, ressources

### ‚ú® Capacit√©s & sorts
- sorts, capacit√©s

### üìù Notes
- priv√©es (owner + MJ)
- publiques

---

## üì∞ Types de posts

- ‚úçÔ∏è RP: narration, dialogues, actions de personnage
- üé≤ Roll: jet de d√©, affichage automatique du r√©sultat, li√© √† un personnage et √† une stat
- üìú Log: journal de campagne, r√©sum√© de session, √©v√®nements
- üó∫Ô∏è Quest: objectifs, qu√™tes en cours, progression
- ‚öîÔ∏è Combat: actions de combat, tours, d√©g√¢ts, √©tats
- ‚öôÔ∏è MJ: annonces, r√®gles, posts √©pingl√©s, narration

Dans le mode "story", les posts ont le type RP par d√©faut.

---

## üé≤ Rolls

```json
{
  "type": "roll",               // savoir que c‚Äôest un post de jet
  "profileId": "pr_123",        // quel personnage a lanc√© le jet
  "stat": "dexterity",          // quelle caract√©ristique est utilis√©e
  "dice": "d20",                // type de d√©
  "baseRoll": 14,               // r√©sultat brut
  "modifier": 3,                // bonus/malus
  "total": 17,                  // total final
  "result": "success",          // interpr√©tation
  "text": "Sneaking past the guards"
}
```

- d20 = succ√®s critique
- d1 = √©chec critique
- interpr√©tation laiss√©e au MJ

---

## üí¨ IC / OOC DMS

Deux espaces de message priv√©s s√©par√©s :
- IC : narration
- OOC : discussion hors-jeu

---

## üìå Posts √©pingl√©s (campagne)

- r√®gles
- r√©sum√©
- qu√™tes

Posts √©pingl√©s, √©ditables par le MJ.


# üõ†Ô∏è Feedverse ‚Äî Documentation technique

> Cette doc d√©crit une API **propos√©e** (backend) pour accompagner l‚Äôapp Feedverse (React Native/Expo) qui, aujourd‚Äôhui, persiste en local via `AsyncStorage` (DB v5).  
> Objectif : rendre l‚Äôapp **syncable**, multi-device, et pr√©parer une vraie couche serveur (auth, m√©dia, pagination, mod√©ration, etc.).

---

## 1) Vue d‚Äôensemble

### Stack cible (suggestion)
- **Mobile** : Expo / React Native
- **Backend** : Node.js + TypeScript + Express/Fastify (au choix)
- **DB** : PostgreSQL (ou Mongo, mais Postgres recommand√©)
- **Stockage m√©dias** : S3 compatible (S3, Cloudflare R2, Supabase Storage, etc.)
- **Auth** : JWT (Access + Refresh) ou session + cookies (selon choix)
- **Observabilit√©** : logs structur√©s + Sentry (mobile + API)

### Principes
- IDs en string
- **Pagination par cursor**
- Endpoints **REST** simples, pr√©visibles
- Validation (Zod/Valibot c√¥t√© API)

---

## 2) Mod√®le de donn√©es (rappel / alignement DB v5)

### User
- `id`, `username`, `avatarUrl`, `createdAt`, `updatedAt?`, `settings?`
- `settings.showTimestamps?`
- `settings.darkMode?` : `'light' | 'dark' | 'system'`

### Scenario
- `id`, `name`, `cover`, `playerIds[]`
- `createdAt`, `updatedAt?`
- `inviteCode`, `ownerUserId`
- `description?`
- `mode`: `'story' | 'campaign'`
- `gmUserIds?`: liste d‚ÄôIDs user ayant le r√¥le MJ
- `tags?`: `ScenarioTag[]`
- `settings?`: actuellement utilis√© comme espace de settings extensibles
  - `profileLimitMode?`: `'per_owner' | 'per_scenario'`
  - `pinnedPostIds?`: `string[]` (ordre d‚Äô√©pinglage)

### ScenarioTag
- `id`, `key`, `name`, `color`

### Profile
- `id`, `scenarioId`, `ownerUserId`
- `displayName`, `handle`, `avatarUrl`, `headerUrl?`, `bio?`
- `isPublic?`, `isPrivate?`, `joinedDate?`, `location?`, `link?`
- `followerCount?`, `followingCount?`, `createdAt`, `updatedAt?`
- likes : via table `likes` (relation `profileId` ‚Üî `postId`) plut√¥t que `likedPostIds[]`

### Like
- `scenarioId`, `profileId`, `postId`, `createdAt`
- unicit√© : 1 like max par (profileId, postId)

### Post
- `id`, `scenarioId`, `authorProfileId`
- `text`
- `createdAt` (**narratif / affichage**) ‚Äî peut √™tre modifi√©
- `insertedAt` (**technique / cr√©ation**) ‚Äî fix√© √† la cr√©ation (utilis√© comme cursor local)
- `updatedAt?`
- `imageUrls?[]`, `replyCount?`, `repostCount?`, `likeCount?`
- `parentPostId?` (reply)
- `quotedPostId?` (quote)
- `postType?`: `'rp' | 'roll' | 'log' | 'quest' | 'combat' | 'gm'`
- `meta?`: payload libre (roll, quest state, combat turn, etc.)
- `isPinned?`, `pinOrder?` (miroir UI des pins)

### Conversation (DM)
- `id`, `scenarioId`
- `participantProfileIds[]` (profils participants)
- `title?`, `avatarUrl?` (utile surtout pour les groupes)
- `createdAt`, `updatedAt?`, `lastMessageAt?`

> Remarque (DB Postgres) : c√¥t√© backend, les participants sont mieux mod√©lis√©s via une table de jointure `conversation_participants(conversation_id, profile_id)` plut√¥t qu‚Äôun `uuid[]`, pour garder l‚Äôint√©grit√© r√©f√©rentielle + des index efficaces.

### Message (DM)
- `id`, `scenarioId`, `conversationId`
- `senderProfileId`
- `text`
- `createdAt`, `updatedAt?`, `editedAt?`

### Repost
- `id` (cl√© `${profileId}|${postId}`), `scenarioId`, `profileId`, `postId`, `createdAt`

### GlobalTag
- `key` (canonique), `name` (label), `color` (d√©terministe)

### CharacterSheet
- `profileId`
- identit√©: `name?`, `race?`, `class?`, `level?`, `alignment?`, `background?`
- stats: `stats.{strength,dexterity,constitution,intelligence,wisdom,charisma}`
- combat: `hp.{current,max,temp?}`, `status?`
- inventaire: `inventory[]`, `equipment?[]`
- sorts/capacit√©s: `spells?[]`, `abilities?[]`
- notes: `publicNotes?`, `privateNotes?`, `updatedAt?`

### DbV5 (container local)
- `version: 5`, `seededAt`
- `users`, `scenarios`, `profiles`, `posts`, `reposts`
- `likes` (table c√¥t√© backend ; local v5 peut rester en d√©riv√©/cache si besoin)
- `tags` (registry global), `sheets` (key = profileId)
- `selectedProfileByScenario: Record<scenarioId, profileId>`

---

## 3) Conventions API

### Base URL
- `https://api.feedverse.app/v1`

### Auth
- `Authorization: Bearer <access_token>`
- refresh via endpoint (ou cookie HTTP-only)

### Horodatage
- ISO 8601 (UTC) : `2025-12-27T10:15:30.000Z`

### Pagination (cursor)
- cursor = `"${insertedAt}|${id}"`
- Tri de pagination (stable) : `insertedAt DESC, id DESC`
- Propri√©t√©s :
  - `limit` (d√©faut 15)
  - `cursor` (start **after** cursor)

> üìù **Note (backend propos√©)** : `createdAt` est une date **narrative/affich√©e** et peut changer (retcon). Dans ce cas, l‚Äôapp **refresh** le feed apr√®s √©dition pour refl√©ter le nouvel ordre visuel. La pagination reste fiable car elle se base sur `insertedAt` (immuable).

> üß† **Note (impl√©mentation locale actuelle)** : `listPostsPage()` trie actuellement par `createdAt DESC, id DESC` (ordre narratif), mais le cursor local est construit via `insertedAt|id` et sert √† retrouver une position dans la liste. Si `createdAt` change, l‚Äôordre et donc la pagination peuvent bouger ‚Üí l‚Äôapp s‚Äôappuie plut√¥t sur un refresh apr√®s certaines √©ditions.

### R√©ponses & erreurs (format)
```json
{
  "data": { },
  "meta": { },
  "error": null
}
```

Erreur :
```json
{
  "data": null,
  "meta": null,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid handle",
    "details": { "handle": "..." }
  }
}
```

Codes recommand√©s : `UNAUTHORIZED`, `FORBIDDEN`, `NOT_FOUND`, `CONFLICT`, `RATE_LIMITED`, `VALIDATION_ERROR`.

---

## 4) Endpoints propos√©s

### 4.1 Auth

#### POST `/auth/login`
Mock / futur login (email+password / oauth).  
**Body**
```json
{ "username": "winter", "password": "..." }
```
**200**
```json
{
  "data": {
    "accessToken": "...",
    "refreshToken": "...",
    "user": { "id": "u14", "username": "winter", "avatarUrl": "...", "createdAt": "..." }
  }
}
```

#### POST `/auth/refresh`
**Body**
```json
{ "refreshToken": "..." }
```

#### POST `/auth/logout`
Invalide le refresh token.

---

### 4.2 Users & Settings

#### GET `/users/me`
Retourne l‚Äôutilisateur connect√©.

#### PATCH `/users/me`
Met √† jour `username`, `avatarUrl` 

#### PATCH `/users/me/settings`
**Body**
```json
{ "showTimestamps": true, "darkMode": "system" }
```

#### GET `/users/:userId`
Public (si besoin), sinon prot√©g√©.

#### GET `/users`
Admin / dev.

---

### 4.3 Scenarios

#### GET `/scenarios`
Liste les sc√©narios disponibles √† l‚Äôutilisateur (ou tous publics).

#### GET `/scenarios/:scenarioId`
D√©tails + players (optionnel via query).

#### POST `/scenarios`
Cr√©er un sc√©nario (owner = userId courant).
**Body**
```json
{ "name": "K-Pop Universe", "cover": "https://...", "playerIds": ["u14","u2"] }
```

#### PATCH `/scenarios/:scenarioId`
√âdit.

#### DELETE `/scenarios/:scenarioId`
Delete.

---

### 4.4 Profiles

#### GET `/scenarios/:scenarioId/profiles`
Query :
- `ownerUserId` (filtre)
- `handle` (exact / lookup)
- `q` (search displayName/handle)
- `limit`, `cursor` (pour la pagination)

Ex :
- `GET /scenarios/sc_1/profiles?ownerUserId=u14`
- `GET /scenarios/sc_1/profiles?handle=jiniret` (@jiniret)

#### GET `/profiles/:profileId`

#### POST `/scenarios/:scenarioId/profiles`
Cr√©er profil.
**Body**
```json
{
  "displayName": "Hyunjin",
  "handle": "jiniret",
  "avatarUrl": "https://...",
  "bio": "..."
}
```

#### PATCH `/profiles/:profileId`
√âdit profil (owner only).

#### DELETE `/profiles/:profileId`
Delete.

---

### 4.5 Posts (feed, replies, quote)

#### GET `/scenarios/:scenarioId/posts`
Feed du sc√©nario (par d√©faut **sans replies**).
Query :
- `limit` (d√©faut 15)
- `cursor`
- `includeReplies=false|true`
- `authorProfileId` (pour √©cran profil)
- `q` (search text)
- `parentPostId` (pour lister les replies d‚Äôun post)

Ex :
- Feed : `GET /scenarios/sc_1/posts?limit=12`
- Page 2 : `GET /scenarios/sc_1/posts?limit=12&cursor=2025-12-27T...Z|k1` *(cursor bas√© sur `insertedAt|id`)*
- Posts d‚Äôun profil : `GET /scenarios/sc_1/posts?authorProfileId=pr_kpop_jinnie`
- Replies : `GET /scenarios/sc_1/posts?parentPostId=k1&sort=asc`

**200**
```json
{
  "data": {
    "items": [ { "id":"k1", "scenarioId":"sc_1", "authorProfileId":"pr_...", "text":"...", "createdAt":"..." } ],
    "nextCursor": "2025-12-27T10:15:30.000Z|k1"
  }
}
```

> Note : pour les replies tu peux choisir tri ASC (comme ton code) via `sort=asc`.

#### GET `/posts/:postId`
Retourne un post + (optionnel) ses relations :
- `?include=replies` (premi√®re page)
- `?include=quoted` (post cit√©)

#### POST `/scenarios/:scenarioId/posts`
Cr√©er un post.
**Body**
```json
{
  "authorProfileId": "pr_kpop_jinnie",
  "text": "hello world",
  "imageUrls": ["https://..."],
  "parentPostId": null,
  "quotedPostId": null
}
```

#### POST `/posts/:postId/replies`
Cr√©er reply (alias du pr√©c√©dent).
**Body**
```json
{ "authorProfileId": "pr_x", "text": "reply", "imageUrls": [] }
```

#### PATCH `/posts/:postId`
√âdit (autoris√© si owner profile).
**Body**
```json
{ "text": "edited text", "imageUrls": ["https://..."] }
```

#### DELETE `/posts/:postId`
Supprime (et supprime replies ou re-parent selon politique).
- Policy recommand√©e : supprimer replies en cascade (comme ton `deletePost` local).

---

### 4.6 Likes / Reposts (optionnel)

#### POST `/posts/:postId/likes`
Like par profile.  
**Body**
```json
{ "profileId": "pr_..." }
```

#### DELETE `/posts/:postId/likes?profileId=pr_...`

> Mod√®le recommand√© : table `likes(profile_id, post_id, scenario_id, created_at)` + PK `(profile_id, post_id)` (1 like max).

#### POST `/posts/:postId/reposts`
#### DELETE `/posts/:postId/reposts?profileId=pr_...`

> Tu peux aussi mod√©liser `Like` et `Repost` comme tables/collections.

---

### 4.7 Media Upload (images)

#### POST `/media/presign`
Retourne une URL de upload (S3 presigned).
**Body**
```json
{ "contentType": "image/jpeg", "fileName": "post_123.jpg" }
```
**200**
```json
{
  "data": {
    "uploadUrl": "https://...",
    "fileUrl": "https://cdn....../post_123.jpg"
  }
}
```

Workflow recommand√© :
1) Mobile demande `presign`
2) Mobile upload direct vers storage
3) Mobile poste `fileUrl` dans `imageUrls[]`

---

### 4.8 S√©lection de profil (selectedProfileByScenario)

Tu as `selectedProfileByScenario: Record<scenarioId, profileId>` dans la DB locale.

#### GET `/scenarios/:scenarioId/selection`
**200**
```json
{ "data": { "selectedProfileId": "pr_..." } }
```

#### PUT `/scenarios/:scenarioId/selection`
**Body**
```json
{ "selectedProfileId": "pr_..." }
```

---

### 4.9 DMs (Conversations + Messages)

Objectif : supporter des DMs **IC** / **OOC** sans casser l‚ÄôUX existante.

#### GET `/scenarios/:scenarioId/conversations`
Liste l‚Äôinbox (conversations o√π le profil participe).

Query :
- `profileId` (profil ‚Äúacteur‚Äù)
- `limit`, `cursor` (optionnel)

#### POST `/scenarios/:scenarioId/conversations`
Cr√©e une conversation (DM 1:1 ou groupe).

**Body**
```json
{
  "participantProfileIds": ["pr_a", "pr_b"],
  "title": null,
  "avatarUrl": null
}
```

#### GET `/conversations/:conversationId/messages`
Liste les messages d‚Äôun thread.

Query :
- `limit`, `cursor` (optionnel)
- `sort=asc|desc` (par d√©faut `asc` pour une UI ‚Äúchat‚Äù)

#### POST `/conversations/:conversationId/messages`
Envoie un message.

**Body**
```json
{ "senderProfileId": "pr_a", "text": "hello" }
```

#### PATCH `/messages/:messageId`
√âdite un message (owner du `senderProfileId` uniquement).

**Body**
```json
{ "text": "edited" }
```

#### DELETE `/messages/:messageId`
Supprime un message.

> Politique (recommandation) : hard delete en V1 (simple). Plus tard : soft delete (`deleted_at`, `deleted_by_profile_id`) si besoin.

---

## 5) Permissions (alignement avec `canEditPost`)

### R√®gle propos√©e
- Un post est √©ditable/supprimable si :
  - user connect√© == owner du `authorProfileId`
  - OU user a un r√¥le admin/mod sur le scenario (future)

M√™me logique pour `Profile` :
- owner seulement (ou admin/mod)

---

## 6) Index & perf (Postgres)

### Index recommand√©s
- `posts (scenario_id, created_at desc, id desc)` *tri narratif*
- `posts (scenario_id, inserted_at desc, id desc)` *pagination stable*
- `posts (parent_post_id, created_at asc, id asc)` *pour replies*
- `profiles (scenario_id, lower(handle)) unique`
- `profiles (scenario_id, owner_user_id)`
- `scenarios_players (scenario_id, user_id)` si table de jointure

### D√©normalisation l√©g√®re
- `replyCount`, `likeCount`, `repostCount` sur `posts`
- recalcul via triggers / jobs / transaction (au choix)

---

## 7) Synchronisation local ‚Üî serveur (migration douce)

### Phase 1 (actuel)
- Local only : `AsyncStorage` DB v3 + seed

### Phase 2 (hybride)
- Read : serveur si online, fallback local
- Write : optimistic local + sync queue (retry)

### Phase 3
- Serveur source of truth
- Local cache + offline mode

> Tr√®s compatible avec ta pagination cursor actuelle.

---

## 8) Exemples rapides (curl)

### Feed (page 1)
```bash
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.feedverse.app/v1/scenarios/sc_1/posts?limit=12"
```

### Feed (page 2)
```bash
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.feedverse.app/v1/scenarios/sc_1/posts?limit=12&cursor=2025-12-27T10:15:30.000Z|k1"
```

### Cr√©er un post
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"authorProfileId":"pr_kpop_jinnie","text":"hello","imageUrls":[]}' \
  "https://api.feedverse.app/v1/scenarios/sc_1/posts"
```

### Inbox (DM)
```bash
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.feedverse.app/v1/scenarios/sc_1/conversations?profileId=pr_kpop_jinnie"
```

### Thread messages (DM)
```bash
curl -H "Authorization: Bearer $TOKEN" \
  "https://api.feedverse.app/v1/conversations/cv_1/messages?sort=asc&limit=50"
```

### Envoyer un message (DM)
```bash
curl -X POST -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"senderProfileId":"pr_kpop_jinnie","text":"hello"}' \
  "https://api.feedverse.app/v1/conversations/cv_1/messages"
```

---

## 9) Mermaid ‚Äî flux API (r√©sum√©)

```mermaid
sequenceDiagram
  autonumber
  participant App as Mobile App
  participant API as Feedverse API
  participant DB as Postgres
  participant S3 as Media Storage

  App->>API: POST /auth/login
  API->>DB: verify user
  DB-->>API: ok
  API-->>App: accessToken + refreshToken

  App->>API: GET /scenarios
  API->>DB: select scenarios for user
  DB-->>API: scenarios
  API-->>App: scenarios list

  App->>API: GET /scenarios/:id/posts?limit=12
  API->>DB: select posts (cursor pagination)
  DB-->>API: posts + nextCursor
  API-->>App: items + nextCursor

  App->>API: POST /media/presign
  API-->>App: uploadUrl + fileUrl
  App->>S3: PUT uploadUrl (image bytes)
  S3-->>App: 200 OK
  App->>API: POST /scenarios/:id/posts (imageUrls=[fileUrl])
  API->>DB: insert post
  DB-->>API: post
  API-->>App: created post
```

---

## 10) TODO V2 (pour aller plus loin)
- endpoint **search** multi-entit√©s (posts/profiles)
- mod√©ration : report/block/mute
- mentions `@handle`, hashtags
- notifications (reply/like/repost)
- webhooks / export scenario



# üèõÔ∏è Feedverse ‚Äî Documentation d‚Äôarchitecture

> **Contexte** : application React Native (Expo) orient√©e ‚Äúsocial simulation / multi-profils‚Äù, avec persistance locale via `AsyncStorage`.
> Cette doc d√©crit l‚Äôarchitecture actuelle bas√©e sur tes fichiers : `schema.ts`, `storage.ts`, `AuthProvider`, `AppDataProvider`, `HomeScreen`, `ScenarioListScreen`.

---

## 1) Vue d‚Äôensemble

### Objectifs
- **Source de v√©rit√© locale** : un objet `DbV5` persiste dans `AsyncStorage` (cl√© `feedverse.db.v1`).
- **Acc√®s aux donn√©es via Context** : `AppDataProvider` expose des *selectors* + *actions* (CRUD).
- **Authentification mock** : `AuthProvider` g√®re `userId` (stock√© s√©par√©ment).
- **Navigation Expo Router** : parcours par scenario (`/(scenario)/:scenarioId`) + modals (create/edit post) + d√©tail post.

---

## 2) Modules et responsabilit√©s

### `mobile/data/db/schema.ts`
- D√©clare les types : `User`, `UserSettings`, `Scenario`, `ScenarioTag`, `Profile`, `Post`, `Repost`, `GlobalTag`, `CharacterSheet`, `DbV5`.
- `DbV5` contient :
  - `users`, `scenarios`, `profiles`, `posts`, `reposts` en `Record<string, T>`
  - `tags: Record<string, GlobalTag>` (registry global de tags)
  - `sheets: Record<string, CharacterSheet>` (key = profileId)
  - `selectedProfileByScenario: Record<scenarioId, profileId>` (profil actif par scenario)
  - m√©tadonn√©es `version`, `seededAt`

### `mobile/data/db/storage.ts`
- Abstraction persistance `AsyncStorage` :
  - `readDb()` : lit + parse JSON
  - `writeDb(db)` : √©crit JSON
  - `updateDb(fn)` : read ‚Üí transform ‚Üí write, retourne le nouveau db

### `mobile/context/auth.tsx`
- Auth ‚Äúmock‚Äù :
  - persiste `feedverse.auth.userId`
  - `signInMock()` fixe `DEV_USER_ID` (ex: `u14`)
  - `signOut()` supprime la cl√©

### `mobile/context/appData.tsx` (ton provider)
- Chargement initial :
  - `readDb()` ‚Üí `seedDbIfNeeded(existing)` ‚Üí `setState({isReady:true, db})`
- **Selectors** :
  - Scenarios: `getScenarioById`, `listScenarios`
  - Profiles: `getProfileById`, `getProfileByHandle`, `listProfilesForScenario`
  - Posts: `getPostById`, `listPostsForScenario`, `listRepliesForPost`
  - Pagination: `listPostsPage({scenarioId, limit, cursor, filter, includeReplies})`
  - Profile feed: `listProfileFeedPage({scenarioId, profileId, tab, limit, cursor})` (posts + reposts)
  - Selection: `getSelectedProfileId`
- **Actions** :
  - `setSelectedProfileId`
  - `upsertProfile`
  - `deleteProfileCascade` (supprime profile + posts/likes/reposts li√©s + nettoie pins/likes/sheet/selection)
  - `upsertPost`
  - `deletePost` (supprime le post, retire les reposts pointant dessus, et le retire des pins)
  - Likes: `toggleLike`, `isPostLikedBySelectedProfile`
  - Reposts: `toggleRepost`, `isPostRepostedBySelectedProfile`
  - Pins: `togglePinPost`, `listPinnedPostsForScenario`, `reorderPinnedPostsForScenario`
  - Sheets: `getCharacterSheetByProfileId`, `upsertCharacterSheet`
  - GM: `gmApplySheetUpdate` (patch sheets + cr√©e un post GM de r√©sum√©)
  - Scenarios avanc√©: join par `inviteCode`, `leaveScenario`, `transferScenarioOwnership`, `transferProfilesToUser`, `adoptPublicProfile`
  - Import/Export: preview/import/export d‚Äôun sc√©nario (profiles/posts/reposts/sheets)

### √âcrans (UI)
- `ScenarioListScreen` :
  - liste les scenarios, affiche avatars des `players` (depuis `User`)
  - actions header : settings (placeholder), logout
- `HomeScreen` :
  - feed pagin√© (`listPostsPage`)
  - `SwipeableRow` si `canEditPost` vrai
  - navigation : create/edit post, post detail
  - ‚Äúrefresh‚Äù simplifi√© apr√®s delete ‚Üí `loadFirstPage()`

---

## 3) Mermaid ‚Äî Composants & d√©pendances

```mermaid
flowchart TB
  subgraph UI["UI (Expo Router Screens)"]
    SL["ScenarioListScreen"]
    HS["HomeScreen (Feed)"]
    CP["Create/Edit Post Modal"]
    PD["Post Detail Screen"]
  end

  subgraph Contexts["Contexts"]
    AUTH["AuthProvider / useAuth"]
    DATA["AppDataProvider / useAppData"]
  end

  subgraph DB["Local DB Layer"]
    SCHEMA["schema.ts (types DbV5)"]
    SEED["seedDbIfNeeded"]
    STORE["storage.ts (readDb/writeDb/updateDb)"]
    AS["AsyncStorage"]
  end

  SL -->|listScenarios/getUserById| DATA
  HS -->|listPostsPage/getProfileById/deletePost| DATA
  CP -->|upsertPost| DATA
  PD -->|getPostById/listRepliesForPost| DATA

  DATA -->|uses| SCHEMA
  DATA -->|init: readDb| STORE
  DATA -->|init: seedDbIfNeeded| SEED
  STORE --> AS

  SL --> AUTH
  HS --> AUTH
  CP --> AUTH
  PD --> AUTH
```

---

## 4) Mermaid ‚Äî Mod√®le de donn√©es (ERD)

> Note : Mermaid ERD ne supporte pas parfaitement les `Record<>` ni les arrays, on les mod√©lise comme relations logiques.

```mermaid
erDiagram
  USER {
    string id PK
    string username
    string avatarUrl
    string createdAt
    string updatedAt
    string settings_darkMode
    boolean settings_showTimestamps
  }

  SCENARIO {
    string id PK
    string name
    string cover
    string inviteCode
    string ownerUserId
    string mode
    string createdAt
    string updatedAt
  }

  PROFILE {
    string id PK
    string scenarioId FK
    string ownerUserId FK
    string displayName
    string handle
    string avatarUrl
    string headerUrl
    string bio
    boolean isPublic
    boolean isPrivate
    string joinedDate
    string location
    string link
    int followerCount
    int followingCount
    string createdAt
    string updatedAt
  }

  POST {
    string id PK
    string scenarioId FK
    string authorProfileId FK
    string text
    string createdAt
    string insertedAt
    string updatedAt
    string parentPostId FK
    string quotedPostId FK
    string postType
    boolean isPinned
    int pinOrder
  }

  REPOST {
    string id PK
    string scenarioId FK
    string profileId FK
    string postId FK
    string createdAt
  }

  LIKE {
    string scenarioId FK
    string profileId PK
    string postId PK
    string createdAt
  }

  CHARACTER_SHEET {
    string profileId PK
    string updatedAt
  }

  GLOBAL_TAG {
    string key PK
    string name
    string color
  }

  SCENARIO_TAG {
    string id PK
    string scenarioId FK
    string key FK
  }

  USER ||--o{ PROFILE : owns
  USER ||--o{ SCENARIO : owns
  SCENARIO ||--o{ PROFILE : contains
  SCENARIO ||--o{ POST : contains
  PROFILE ||--o{ POST : authors
  POST ||--o{ POST : replies
  POST }o--|| POST : quotes

  PROFILE ||--o{ REPOST : creates
  POST ||--o{ REPOST : target
  SCENARIO ||--o{ REPOST : contains

  PROFILE ||--o{ LIKE : likes
  POST ||--o{ LIKE : likedBy
  SCENARIO ||--o{ LIKE : contains

  PROFILE ||--o| CHARACTER_SHEET : has

  SCENARIO ||--o{ SCENARIO_TAG : has
  GLOBAL_TAG ||--o{ SCENARIO_TAG : registry
```

---

## 5) Mermaid ‚Äî S√©quence de d√©marrage (boot)

```mermaid
sequenceDiagram
  participant UI as App (root)
  participant AUTH as AuthProvider
  participant DATA as AppDataProvider
  participant STORE as storage.ts
  participant AS as AsyncStorage
  participant SEED as seedDbIfNeeded

  UI->>AUTH: mount
  AUTH->>AS: getItem(feedverse.auth.userId)
  AS-->>AUTH: userId|null
  AUTH-->>UI: isReady=true

  UI->>DATA: mount
  DATA->>STORE: readDb()
  STORE->>AS: getItem(DB_KEY)
  AS-->>STORE: raw|null
  STORE-->>DATA: db|null
  DATA->>SEED: seedDbIfNeeded(existing)
  SEED-->>DATA: DbV5
  DATA-->>UI: isReady=true + db
```

---

## 6) Mermaid ‚Äî Pagination du feed (listPostsPage)

```mermaid
flowchart TD
  A["listPostsPage(args)"] --> B["Filtrer posts par scenarioId"]
  B --> C{"includeReplies ?"}
  C -- "non" --> D["Exclure parentPostId (top-level seulement)"]
  C -- "oui" --> E["Garder replies incluses"]
  D --> F
  E --> F["Appliquer filter(p) si fourni"]
  F --> G["Sort DESC (createdAt, id) (ordre narratif)"]
  G --> H{"cursor fourni ?"}
  H -- "non" --> I["startIndex = 0"]
  H -- "oui" --> J["startIndex = index(cursor)+1 (cursor = insertedAt|id)"]
  I --> K["slice(startIndex, startIndex+limit)"]
  J --> K
  K --> L{"page pleine ?"}
  L -- "oui" --> M["nextCursor = cursor(dernier item)"]
  L -- "non" --> N["nextCursor = null"]
```

---

## 6.1) Mermaid ‚Äî Pagination feed profil (listProfileFeedPage)

`listProfileFeedPage` construit un flux par profil, m√©langeant **posts** et **reposts** tri√©s par `activityAt`.

```mermaid
flowchart TD
  A["listProfileFeedPage(args)"] --> B["Charger posts du scenario"]
  B --> C["Filtrer selon tab (posts/media/replies/likes)"]
  C --> D["Charger repost events du profil (tab=posts)"]
  D --> E["Construire items: kind=post|repost + activityAt"]
  E --> F["Sort DESC (activityAt, kind, post.id)"]
  F --> G{"cursor fourni ?"}
  G -- "non" --> H["startIndex = 0"]
  G -- "oui" --> I["startIndex = index(cursor)+1 (cursor=activityAt|kind|postId|reposterId)"]
  H --> J["slice(startIndex, startIndex+limit)"]
  I --> J
  J --> K{"page pleine ?"}
  K -- "oui" --> L["nextCursor = cursor(dernier item)"]
  K -- "non" --> M["nextCursor = null"]
```

---

## 7) Comportements cl√©s et r√®gles

### Posts & Replies
- Un post est une reply si `parentPostId` est d√©fini.
- Le feed ‚ÄúHome‚Äù liste par d√©faut **seulement les top-level posts** (`!parentPostId`).
- Les replies sont r√©cup√©r√©es via `listRepliesForPost(postId)` et tri√©es en **ASC** (`createdAt`, `id`).

### Stabilit√© de tri
- Les tris utilisent `localeCompare` sur `createdAt` (ISO string) + `id`.
- √áa assure un ordre stable m√™me si des posts ont le m√™me timestamp.
- **Cursor local** : construit sur `insertedAt|id`.
- **Affichage narratif** : re-trier sur `createdAt` apr√®s un refresh (si cette date √† √©t√© modifi√©e).

### Suppression
- `deletePost(postId)` supprime :
  - le post cibl√©
  - tous les repost events qui pointent vers ce post
  - tous les likes pointant vers ce post
  - la r√©f√©rence dans `scenario.settings.pinnedPostIds` si le post √©tait √©pingl√©

- `deleteProfileCascade(scenarioId, profileId)` supprime :
  - le profile
  - tous les posts dont il est l‚Äôauteur
  - ses likes (table `likes`) + d√©cr√©mente les `likeCount` des posts concern√©s
  - ses reposts + d√©cr√©mente `repostCount`
  - sa fiche (`sheets[profileId]`)
  - nettoie les pins + la s√©lection active si n√©cessaire

---

## 8) Contraintes & points d‚Äôattention

### 8.1 DB en m√©moire vs AsyncStorage
- Le provider maintient `db` en state React.
- Toute mutation passe par `updateDb(fn)` puis `setState` avec le r√©sultat.
- ‚ö†Ô∏è Si d‚Äôautres parties de l‚Äôapp √©crivent dans AsyncStorage sans passer par `AppDataProvider`, tu peux avoir des incoh√©rences UI (state vs storage).

### 8.2 Pagination ‚Äúcursor‚Äù 
- Le cursor est bas√© sur `insertedAt|id` (**stable**).
- `createdAt` est une date **narrative/affich√©e** et peut √™tre modifi√©e (retcon).
- Apr√®s une √©dition qui change `createdAt`, l‚Äôapp **refresh** le feed pour refl√©ter le nouvel ordre visuel.

### 8.3 S√©lection du profil actif
- `selectedProfileByScenario[scenarioId]` est la cl√© centrale pour savoir ‚Äúqui poste / agit‚Äù.
- Pense √† fallback (si supprim√©) : choisir le premier profile du user dans le scenario, etc. (si tu ajoutes cette logique plus tard).

---

## 9) Extensions recommand√©es (architecture)

### 9.1 Split ‚Äúselectors‚Äù / ‚Äúcommands‚Äù
- Garder `AppDataApi` mais s√©parer :
  - `selectors.*` (pure, sync)
  - `commands.*` (async, persiste)
- Avantage : testabilit√© + lisibilit√©.

### 9.2 Indexs d√©riv√©s en m√©moire (perf)
Pour des gros sc√©narios :
- `profilesByScenarioId`
- `postsByScenarioId` tri√©s
- `repliesByParentId`
- Rebuild √† chaque update (ou memo) pour √©viter des `Object.values().filter().sort()` trop fr√©quents.

---
